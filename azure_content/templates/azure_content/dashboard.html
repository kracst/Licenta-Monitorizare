{% extends "azure_content/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Sensor Cards Row -->
   <div class="row mb-4">
    <!-- Temperature Card -->
    <div class="col-12 col-md-3 mb-3">
        <div class="card bg-danger text-white shadow-sm border-0">
            <div class="card-body text-center p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <i class="fas fa-thermometer-half fa-2x"></i>
                    <span class="badge bg-white text-danger rounded-pill">Live</span>
                </div>
                <h5 class="mb-1">Temperatură</h5>
                <h2 class="mb-0 card-value" id="temperature-value">{{ sensor_data.0.temperature|default:"--" }}°C</h2>
                <small class="text-white-50">Actualizată: <span id="temperature-time">Chiar acum</span></small>
            </div>
        </div>
    </div>

    <!-- Humidity Card -->
    <div class="col-12 col-md-3 mb-3">
        <div class="card bg-primary text-white shadow-sm border-0">
            <div class="card-body text-center p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <i class="fas fa-tint fa-2x"></i>
                    <span class="badge bg-white text-primary rounded-pill">Live</span>
                </div>
                <h5 class="mb-1">Umiditate</h5>
                <h2 class="mb-0 card-value" id="humidity-value">{{ sensor_data.0.humidity|default:"--" }}%</h2>
                <small class="text-white-50">Actualizată: <span id="humidity-time">Chiar acum</span></small>
            </div>
        </div>
    </div>

    <!-- Luminosity Card -->
    <div class="col-12 col-md-3 mb-3">
        <div class="card bg-warning text-white shadow-sm border-0">
            <div class="card-body text-center p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <i class="fas fa-lightbulb fa-2x"></i>
                    <span class="badge bg-white text-warning rounded-pill">Offline</span>
                </div>
                <h5 class="mb-1">Luminozitate</h5>
                <h2 class="mb-0 card-value">-- lx</h2>
                <small class="text-white-50">Actualizată: --</small>
            </div>
        </div>
    </div>

     <!--pH Level Card --> 
    <div class="col-12 col-md-3 mb-3">
        <div class="card bg-success text-white shadow-sm border-0">
            <div class="card-body text-center p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <i class="fas fa-flask fa-2x"></i>
                    <span class="badge bg-white text-success rounded-pill">Offline</span>
                </div>
                    <h5 class="mb-1">NIvel pH</h5>
                    <h2 class="mb-0 card-value">--</h2>
                    <small class="text-white-50">Actualizată: --</small>
                </div>
            </div>
        </div>
    </div>
    <!-- Summary Stats Row -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-danger bg-opacity-10 p-3 rounded me-3">
                            <i class="fas fa-arrow-up text-danger"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Temperatura maximă</h6>
                            <h4 class="mb-0" id="max-temp">-- °C</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 p-3 rounded me-3">
                            <i class="fas fa-arrow-down text-primary"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Temperatura minimă</h6>
                            <h4 class="mb-0" id="min-temp">-- °C</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                            <i class="fas fa-calculator text-success"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Temperatura medie</h6>
                            <h4 class="mb-0" id="avg-temp">-- °C</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Summary Stats Row for Humidity -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-danger bg-opacity-10 p-3 rounded me-3">
                            <i class="fas fa-tint text-danger"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Umiditate maximă</h6>
                            <h4 class="mb-0" id="max-humidity">-- %</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                     <div class="bg-primary bg-opacity-10 p-3 rounded me-3">
                            <i class="fas fa-tint-slash text-primary"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Umiditate minimă</h6>
                            <h4 class="mb-0" id="min-humidity">-- %</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                            <i class="fas fa-percent text-success"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Umiditate medie</h6>
                            <h4 class="mb-0" id="avg-humidity">-- %</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Charts Section -->
    <div class="row mb-4">
        <!-- Temperature Chart -->
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-thermometer-half me-2 text-danger"></i>
                        <span class="fw-bold">Tabel Temperatură</span>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="tempTimeRange" data-bs-toggle="dropdown">
                            24 ore
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item time-range" href="#" data-range="1">Ultima oră</a></li>
                            <li><a class="dropdown-item time-range" href="#" data-range="6">6 ore</a></li>
                            <li><a class="dropdown-item time-range active" href="#" data-range="24">24 ore</a></li>
                            <li><a class="dropdown-item time-range" href="#" data-range="168">Ultima săptămână</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body p-3" style="height: 300px;">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Humidity Chart -->
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-tint me-2 text-primary"></i>
                        <span class="fw-bold">Tabel Umiditate</span>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="humidityTimeRange" data-bs-toggle="dropdown">
                            24 ore
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item time-range" href="#" data-range="1">Ultima oră</a></li>
                            <li><a class="dropdown-item time-range" href="#" data-range="6">6 ore</a></li>
                            <li><a class="dropdown-item time-range active" href="#" data-range="24">24 ore</a></li>
                            <li><a class="dropdown-item time-range" href="#" data-range="168">Ultima săptămână</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body p-3" style="height: 300px;">
                    <canvas id="humidityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Sensor Data Table -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-database me-2"></i>
                        <span class="fw-bold">Jurnal de date al senzorului</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="refresh-data">
                            <i class="fas fa-sync-alt me-1"></i> Reîmprospătează
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Temperatură (°C)</th>
                                    <th>Umiditate (%)</th>
                                    <th>Marca temporală</th>
                                    <th>Starea</th>
                                </tr>
                            </thead>
                            <tbody id="sensor-data-body">
                                {% for data in sensor_data %}
                                <tr>
                                    <td>{{ data.temperature }}</td>
                                    <td>{{ data.humidity }}</td>
                                    <td>{{ data.timestamp }}</td>
                                    <td><span class="badge bg-success">Normal</span></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">Nu există date disponibile</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Toast Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Alertă de sistem</strong>
            <small>Chiar acum</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
            Date noi ale senzorului primite
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
<script>
    // Initialize Temperature Chart
    const temperatureChart = new Chart(document.getElementById('temperatureChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperature (°C)',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                data: [],
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleFont: { size: 14 },
                    bodyFont: { size: 12 },
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.y}°C`;
                        }
                    }
                },
                zoom: {
                    zoom: {
                        wheel: { enabled: true },
                        pinch: { enabled: true },
                        mode: 'x'
                    },
                    pan: {
                        enabled: true,
                        mode: 'x'
                    }
                }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                    font: {
                        size: 16 // Increase the font size here
                    },
                    color: '#333' // Optional: Set the color of the labels
                },
                grid: {
                    display: false // Disable gridlines for the Y-axis
                }
                }
            }
        }
    });
    // Initialize Humidity Chart
    const humidityChart = new Chart(document.getElementById('humidityChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Humidity (%)',
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                data: [],
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleFont: { size: 14 },
                    bodyFont: { size: 12 },
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.y}%`;
                        }
                    }
                },
                zoom: {
                    zoom: {
                        wheel: { enabled: true },
                        pinch: { enabled: true },
                        mode: 'x'
                    },
                    pan: {
                        enabled: true,
                        mode: 'x'
                    }
                }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                    font: {
                        size: 16 // Increase the font size here
                    },
                    color: '#333' // Optional: Set the color of the labels
                },
                grid: {
                    display: false // Disable gridlines for the Y-axis
                }
                }
            }
        }
    });

    function fetchSensorData() {
        fetch('/api/get_sensor_data/')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('sensor-data-body');
                tableBody.innerHTML = '';

                if (data.length === 0) return;

                const reversedData = data.reverse();

                // Update card values
                const latestData = data[0];
                document.getElementById('humidity-value').textContent = `${latestData.humidity}%`;
                document.getElementById('temperature-value').textContent = `${latestData.temperature}°C`;

                // Update timestamps
                const now = new Date();
                document.getElementById('humidity-time').textContent = now.toLocaleTimeString();
                document.getElementById('temperature-time').textContent = now.toLocaleTimeString();

                // Prepare data for table and charts
                const temperatureData = [];
                const humidityData = [];
                const timestamps = [];

                reversedData.forEach(item => {
                    const formattedDate = new Date(item.timestamp).toLocaleString('en-GB', { 
                        day: '2-digit', month: '2-digit', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });

                    // Add to table
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.temperature}</td>
                        <td>${item.humidity}</td>
                        <td>${formattedDate}</td>
                        <td><span class="badge bg-success">Normal</span></td>
                    `;
                    tableBody.appendChild(row);

                    // Prepare chart data
                    timestamps.push(formattedDate);
                    temperatureData.push(item.temperature);
                    humidityData.push(item.humidity);
                });

                // Update charts
                updateTemperatureChart(temperatureData, timestamps);
                updateHumidityChart(humidityData, timestamps);
                
                // Update summary stats
                updateSummaryStats(data);
            })
            .catch(error => console.error('Error:', error));
    }

    function updateTemperatureChart(data, labels) {
        temperatureChart.data.labels = labels;
        temperatureChart.data.datasets[0].data = data;
        temperatureChart.update();
    }

    function updateHumidityChart(data, labels) {
        humidityChart.data.labels = labels;
        humidityChart.data.datasets[0].data = data;
        humidityChart.update();
    }

    function updateSummaryStats(data) {
        if (data.length === 0) return;
        
        const temps = data.map(item => item.temperature);
        document.getElementById('max-temp').textContent = `${Math.max(...temps).toFixed(1)}°C`;
        document.getElementById('min-temp').textContent = `${Math.min(...temps).toFixed(1)}°C`;
        document.getElementById('avg-temp').textContent = `${(temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1)}°C`;
        const humidities = data.map(item => item.humidity);
        document.getElementById('max-humidity').textContent = `${Math.max(...humidities).toFixed(1)}%`;
        document.getElementById('min-humidity').textContent = `${Math.min(...humidities).toFixed(1)}%`;
        document.getElementById('avg-humidity').textContent = `${(humidities.reduce((a, b) => a + b, 0) / humidities.length).toFixed(1)}%`;
    }

    // Time range selection
    document.querySelectorAll('.time-range').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.time-range').forEach(el => el.classList.remove('active'));
            this.classList.add('active');
            const dropdownButton = this.closest('.dropdown-menu').previousElementSibling;
            dropdownButton.textContent = this.textContent;
            fetchSensorData();
        });
    });

    // Refresh button
    document.getElementById('refresh-data').addEventListener('click', function() {
        fetchSensorData();
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        fetchSensorData();
        setInterval(fetchSensorData, 5000); // Refresh every 30 seconds
    });
</script>

<style>
    @media (max-width: 768px) {
        .card-value {
            font-size: 1.5rem;
        }
        .card-icon {
            font-size: 1.2rem;
        }
    }
    
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    body {
    background-color: #d4edda; /* Light green background */
    }
</style>

{% endblock content %}